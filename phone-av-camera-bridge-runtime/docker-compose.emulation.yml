services:
  rtsp-server:
    image: bluenviron/mediamtx:latest
    restart: unless-stopped

  rtsp-publisher:
    build:
      context: .
      dockerfile: ./tests/emulation/Dockerfile.tester
    depends_on:
      - rtsp-server
    command:
      - /bin/bash
      - -lc
      - "while true; do ffmpeg -hide_banner -loglevel warning -re -f lavfi -i testsrc=size=1280x720:rate=30 -pix_fmt yuv420p -c:v libx264 -preset veryfast -tune zerolatency -f rtsp -rtsp_transport tcp rtsp://rtsp-server:8554/live || true; sleep 1; done"

  bridge-test:
    build:
      context: .
      dockerfile: ./tests/emulation/Dockerfile.tester
    depends_on:
      - rtsp-server
      - rtsp-publisher
    working_dir: /workspace/phone-av-camera-bridge-runtime
    volumes:
      - ./:/workspace/phone-av-camera-bridge-runtime:ro
    command:
      - sleep
      - infinity
