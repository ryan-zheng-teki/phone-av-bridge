#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
REQUIREMENTS_FILE="${SCRIPT_DIR}/requirements.txt"
VENV_PYTHON="${SCRIPT_DIR}/.venv/bin/python3"
ENV_FILE="${SCRIPT_DIR}/.voice-codex.env"

ensure_local_venv() {
  if [[ -x "${VENV_PYTHON}" ]]; then
    return
  fi
  if ! command -v python3 >/dev/null 2>&1; then
    echo "[voice-codex] python3 not found in PATH." >&2
    exit 1
  fi
  echo "[voice-codex] creating local virtualenv at ${SCRIPT_DIR}/.venv" >&2
  python3 -m venv "${SCRIPT_DIR}/.venv"
}

ensure_python_deps() {
  if "${VENV_PYTHON}" - <<'PY' >/dev/null 2>&1
import importlib.util
required_modules = ("faster_whisper", "requests")
missing = [name for name in required_modules if importlib.util.find_spec(name) is None]
raise SystemExit(0 if not missing else 1)
PY
  then
    return
  fi

  echo "[voice-codex] installing Python dependencies..." >&2
  "${VENV_PYTHON}" -m pip install -r "${REQUIREMENTS_FILE}"
}

load_voice_defaults() {
  if [[ -f "${ENV_FILE}" ]]; then
    set -a
    # shellcheck source=/dev/null
    source "${ENV_FILE}"
    set +a
  fi

  if [[ -z "${STT_LANGUAGE:-}" && -n "${LANG_CODE:-}" ]]; then
    STT_LANGUAGE="${LANG_CODE}"
  fi

  : "${STT_LANGUAGE:=zh}"
  : "${STT_MODEL:=small}"

  lang_lower="$(printf '%s' "${STT_LANGUAGE}" | tr '[:upper:]' '[:lower:]')"
  if [[ "${lang_lower}" == zh* && "${STT_MODEL}" == *.en ]]; then
    STT_MODEL="small"
  fi

  export STT_LANGUAGE STT_MODEL
}

ensure_local_venv
ensure_python_deps
load_voice_defaults

exec "${VENV_PYTHON}" "${SCRIPT_DIR}/cli.py" "$@"
